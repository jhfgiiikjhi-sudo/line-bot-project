// ========================================
// STC Chatbot - index.js (ULTIMATE FINAL COMPLETE)
// ========================================

const cheerio = require("cheerio");
const mongoose = require("mongoose");
const express = require("express");
const app = express();
require("dotenv").config();

const fs = require("fs");
const line = require("@line/bot-sdk");
const OpenAI = require("openai");
const moment = require("moment-timezone");
require("moment/locale/th");

const collegeData = require("./collegeData");
const officialFacts = require("./officialFacts");
const MONGO_URI = process.env.MONGO_URI;

mongoose.connect(MONGO_URI)
  .then(() => console.log("üçÉ Connected to MongoDB"))
  .catch(err => {
    console.error("‚ùå MongoDB Error:", err);
    // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß Mongoose ‡∏à‡∏∞‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° Reconnect ‡πÄ‡∏≠‡∏á‡∏ï‡∏≤‡∏° default
  });

// 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Schema)
const userSchema = new mongoose.Schema({
  userId: { type: String, unique: true, required: true },
  realName: String,
  nickName: String,
  age: Number,
  department: String,
  birthday: String,
  step: { type: String, default: "ask_realname" },
  badCount: { type: Number, default: 0 },
  blockedUntil: Date,
  tempReport: {
    title: String,
    detail: String
  }
});

const User = mongoose.model("User", userSchema);

// ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö (‡πÄ‡∏ä‡πà‡∏ô ID ‡∏Ç‡πà‡∏≤‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
const systemStatusSchema = new mongoose.Schema({
    key: { type: String, default: "last_news_id" },
    value: String
});
const SystemStatus = mongoose.model("SystemStatus", systemStatusSchema);

// ‡πÄ‡∏û‡∏¥‡πà‡∏° Schema ‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å SystemStatus
const nameStatsSchema = new mongoose.Schema({
  type: { type: String, enum: ['real', 'nick'], required: true },
  name: { type: String, required: true },
  count: { type: Number, default: 1 }
});
const NameStat = mongoose.model("NameStat", nameStatsSchema);

// ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤
const DEPARTMENTS = [
    "‡∏ä‡πà‡∏≤‡∏á‡∏¢‡∏ô‡∏ï‡πå", "‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á", "‡∏ä‡πà‡∏≤‡∏á‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå", 
    "‡∏ä‡πà‡∏≤‡∏á‡∏Å‡∏•‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô", "‡∏ä‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á", "‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏•‡∏´‡∏∞", 
    "‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ", "‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î", "‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®", "IT", 
    "‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Å‡∏£‡∏≤‡∏ü‡∏¥‡∏Å", "‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏•‡∏à‡∏¥‡∏™‡∏ï‡∏¥‡∏Å‡∏™‡πå", "‡∏ä‡πà‡∏≤‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏¢‡∏≤‡∏ô", "‡πÑ‡∏≠‡∏ó‡∏µ"
];

// ========================================
// FILE STORAGE (‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ä‡∏∑‡πà‡∏≠)
// ========================================
const NAME_STATS_FILE = "./name_stats.json";
let nameStats = { real: {}, nick: {} };

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
const loadData = () => {
    try {
        if (fs.existsSync(NAME_STATS_FILE)) {
            const statsData = fs.readFileSync(NAME_STATS_FILE, "utf8");
            nameStats = statsData ? JSON.parse(statsData) : { real: {}, nick: {} };
        }
    } catch (e) {
        console.error("‚ùå Error loading data:", e);
        nameStats = { real: {}, nick: {} };
    }
};
loadData();

// ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
const saveStats = () => {
    try {
        const data = nameStats || { real: {}, nick: {} };
        fs.writeFileSync(NAME_STATS_FILE, JSON.stringify(data, null, 2), "utf8");
    } catch (e) {
        console.error("‚ùå Save Stats Error:", e);
    }
};

// ========================================
// LINE & OPENAI CONFIG
// ========================================
const config = {
  channelAccessToken: process.env.token,
  channelSecret: process.env.secretcode,
};
const client = new line.Client(config);

const openai = new OpenAI({
  apiKey: process.env.OPENAI_KEY,
});

// ========================================
// UTIL (VALIDATION - EXTREME HARDENED VERSION)
// ========================================

// --- 1. CONSTANTS (‡∏£‡∏ß‡∏°‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà) ---

const FORBIDDEN_NAMES = [
    "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ","‡∏´‡∏ß‡∏±‡∏î‡∏î‡∏µ","‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì","‡∏Ñ‡∏£‡∏±‡∏ö","‡∏Ñ‡πà‡∏∞","‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö","‡∏î‡∏µ‡∏Ñ‡πà‡∏∞",
    "hello","hi","hey","ok","okay","test","‡∏ó‡∏î‡∏™‡∏≠‡∏ö",
    "admin","user","bot","system"
];

const BLACKLIST_WORDS = [
    "‡∏Ñ‡∏ß‡∏¢", "‡πÄ‡∏¢‡πá‡∏î", "‡πÄ‡∏´‡∏µ‡πâ‡∏¢", "‡∏™‡∏±‡∏™", "‡∏´‡∏µ", "‡πÅ‡∏ï‡∏î", "‡∏°‡∏∂‡∏á", "‡∏Å‡∏π", 
    "‡∏î‡∏≠‡∏Å‡∏ó‡∏≠‡∏á", "‡∏Å‡∏∞‡∏´‡∏£‡∏µ‡πà", "‡∏£‡∏∞‡∏¢‡∏≥", "‡∏ä‡∏¥‡∏ö‡∏´‡∏≤‡∏¢",
    "fuck", "shit", "bitch", "pussy", "dick", "cunt", "kuy", "yed"
];

const EXTREME_BAD_PATTERNS = [
    // ‡∏î‡∏±‡∏Å‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢: ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏¢‡∏±‡∏ç‡∏ä‡∏ô‡∏∞‡∏´‡∏•‡∏±‡∏Å + ‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏Ñ‡∏±‡πà‡∏ô‡∏Å‡∏•‡∏≤‡∏á
    /[‡∏Ñ‡∏Ç].*[‡∏ß‡∏†].*[‡∏¢‡∏ç]/,        // ‡∏Ñ*‡∏ß*‡∏¢
    /[‡πÄ‡∏´‡πÄ].*‡∏µ.*‡πâ.*‡∏¢/,           // ‡πÄ*‡∏µ*‡πâ‡∏¢
    /[‡∏™‡∏™].*‡∏±.*[‡∏™‡∏™]/,           // ‡∏™*‡∏±*‡∏™
    /‡∏´.*‡∏µ/,                    // ‡∏´*‡∏µ
    /[‡πÄ‡∏¢‡πÄ].*‡πá.*‡∏î/,             // ‡πÄ*‡∏¢*‡πá*‡∏î
    /‡∏Å.*‡∏π.*‡∏°.*‡∏∂.*‡∏á/,           // ‡∏Å‡∏£‡∏π ‡∏°‡∏∂‡∏á
    /‡∏î.*‡∏≠.*‡∏Å.*‡∏ó.*‡∏≠.*‡∏á/,        // ‡∏î‡∏≠‡∏Å‡∏ó‡∏≠‡∏á
    /‡∏ä.*‡∏¥.*‡∏ö.*‡∏´.*‡∏≤.*‡∏¢/,        // ‡∏ä‡∏¥‡∏ö‡∏´‡∏≤‡∏¢
    /‡πÅ.*‡∏ï.*‡∏î/,                 // ‡πÅ‡∏ï‡∏î
    /‡∏£‡∏∞.*‡∏¢.*‡∏≥/,                // ‡∏£‡∏∞‡∏¢‡∏≥

    // ‡∏î‡∏±‡∏Å‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©: ‡∏î‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏Ñ‡∏±‡πà‡∏ô
    /f.*u.*c.*k/i, 
    /s.*h.*i.*t/i, 
    /b.*i.*t.*c.*h/i, 
    /a.*s.*s/i, 
    /p.*u.*s.*s.*y/i,
    /d.*i.*c.*k/i,
    /c.*u.*m/i
];

// --- 2. CORE FUNCTIONS (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å) ---

/**
 * ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (Normalization) 
 * ‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ ‡∏•‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞‡∏û‡∏¥‡πÄ‡∏®‡∏©
 */
function hardenText(text) {
    if (!text) return "";
    return text.toLowerCase()
        .replace(/\s+/g, "") 
        .replace(/[0‡πë]/g, "o").replace(/[1‡πë]/g, "i").replace(/[3‡πì]/g, "e")
        .replace(/[4‡πî]/g, "a").replace(/[5‡πï]/g, "s").replace(/[7‡πó]/g, "t")
        .replace(/[^‡∏Å-‡πôa-zA-Z0-9]/g, ""); 
}

/**
 * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏´‡∏¢‡∏≤‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á (3 ‡∏ä‡∏±‡πâ‡∏ô)
 */
function isExtremelyBad(text) {
    if (!text) return false;
    const clean = hardenText(text);
    
    // üõë ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏Ñ‡∏≥‡∏™‡∏∏‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô (White-list) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏≠‡∏á‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏´‡∏¢‡∏≤‡∏ö
    const whiteList = ["‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ", "‡∏´‡∏ß‡∏±‡∏î‡∏î‡∏µ", "‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì", "‡∏Ñ‡∏£‡∏±‡∏ö", "‡∏Ñ‡πà‡∏∞", "‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö", "‡∏î‡∏µ‡∏Ñ‡πà‡∏∞"];
    if (whiteList.some(word => clean.includes(hardenText(word)))) {
        return false; 
    }

    // ‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 1: Check Blacklist
    if (BLACKLIST_WORDS.some(word => clean.includes(word))) return true;

    // ‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 2: Check Regex Patterns (‡∏î‡∏±‡∏Å‡∏Ñ‡∏≥‡∏•‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á/‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏∏‡∏î)
    if (EXTREME_BAD_PATTERNS.some(pattern => pattern.test(clean))) return true;

    // ‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏î‡∏±‡∏Å‡∏û‡∏¢‡∏±‡∏ç‡∏ä‡∏ô‡∏∞‡∏î‡πà‡∏≤‡∏•‡πâ‡∏ß‡∏ô‡πÜ (Keyboard Smash)
    // ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏î‡∏±‡∏Å‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Ç‡∏∂‡πâ‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏ô‡∏Ñ‡∏≥‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
    const rudeSmash = /^[‡∏Ñ‡∏ß‡∏¢‡πÄ‡∏´‡∏µ‡πâ‡∏¢‡∏™‡∏±‡∏™‡∏Å‡∏°]+$/;
    if (clean.length >= 2 && rudeSmash.test(clean)) {
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡∏≥‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà‡∏û‡∏¢‡∏±‡∏ç‡∏ä‡∏ô‡∏∞‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ
        return true;
    }

    return false;
}

/**
 * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡πÅ‡∏õ‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô
 */
function isSpam(text) {
    if (!text) return false;
    // ‡∏î‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏£‡∏±‡∏ß‡πÜ
    if (/^[!?@#\$%\^&\*\(\)\+=\-_.]{3,}$/.test(text)) return true;
    // ‡∏î‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ã‡πâ‡∏≥‡πÄ‡∏Å‡∏¥‡∏ô 4 ‡∏ï‡∏±‡∏ß
    if (/(.)\1{4,}/.test(text)) return true;
    return false;
}

/**
 * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö Filter ‡∏´‡∏•‡∏±‡∏Å
 */
function detectMessageType(text) {
    if (!text) return "normal";
    // ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏•‡πâ‡∏ß‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏≤‡∏¢‡∏∏) ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
    if (/^\d+$/.test(text)) return "normal"; 
    if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(text)) return "normal";
    
    if (isExtremelyBad(text)) return "badword";
    if (!/[‡∏Å-‡πôa-z0-9]/i.test(text) || isSpam(text)) return "spam";
    
    return "normal";
}

// --- 3. REGISTRATION HELPERS (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô) ---

function containsBadWord(text) {
    return isExtremelyBad(text);
}

function isForbidden(t) {
    if (!t) return false;
    return FORBIDDEN_NAMES.includes(t.toLowerCase());
}

function isStrictlyHumanName(text) {
    if (!text || text.length < 2 || text.length > 50) return false; // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß
    if (isSpam(text) || containsBadWord(text)) return false;
    
    // ‡∏õ‡∏£‡∏±‡∏ö Regex ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•)
    if (!/^[a-zA-Z‡∏Å-‡πô\s]+$/.test(text)) return false;

    const hasThaiVowel = /[‡∏∞‡∏≤‡∏¥‡∏µ‡∏∂‡∏∑‡∏∏‡∏π‡πÄ‡πÅ‡πÇ‡πÉ‡πÑ‡∏≥‡∏±‡πá]/.test(text);
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡πÅ‡∏•‡∏∞‡∏¢‡∏≤‡∏ß‡∏Å‡∏ß‡πà‡∏≤ 3 ‡∏ï‡∏±‡∏ß ‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏™‡∏£‡∏∞
    if (/[‡∏Å-‡∏Æ]/.test(text) && text.length > 3 && !hasThaiVowel && !text.includes("‡πå")) return false;
    
    return true;
}

function isHumanName(text, min, max) {
    if (!text) return false;
    const validThaiEng = /^[‡∏Å-‡πôa-zA-Z]+$/.test(text) && text.length >= min && text.length <= max;
    if (!validThaiEng) return false;
    if (isForbidden(text) || isSpam(text) || containsBadWord(text)) return false;
    
    // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏™‡∏£‡∏∞‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö
    if (/^[‡∏Å-‡∏Æ]+$/.test(text) && !/[‡∏∞‡∏≤‡∏¥‡∏µ‡∏∂‡∏∑‡∏∏‡∏π‡πÄ‡πÅ‡πÇ‡πÉ‡πÑ‡∏≥‡∏±‡πá]/.test(text)) return false;
    if (/^[a-zA-Z]+$/.test(text) && !/[aeiou]/i.test(text)) return false;
    
    return true;
}

function looksSwapped(real, nick) {
    if (!real || !nick) return false;
    return (nick.length >= real.length + 3) || (real.length <= 3 && nick.length >= 6);
}

function isLikelyNickname(text) {
    if (!text) return false;
    return text.length <= 5; 
}

// ========================================
// HELPERS (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô)
// ========================================
function reply(event, message) {
    return client.replyMessage(event.replyToken, { type: "text", text: message });
}

async function increaseWarning(user) {
    try {
        await client.pushMessage(user.userId, {
            type: "text",
            text: "‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° ‡∏´‡∏≤‡∏Å‡∏Ñ‡∏£‡∏ö 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"
        });
    } catch (err) {
        console.error("Push Warning Error:", err);
    }
}

// ========================================
// NEWS SYNC (‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
// ========================================
const cron = require("node-cron");
const axios = require("axios");

// ‡πÄ‡∏Å‡πá‡∏ö ID ‡∏Ç‡πà‡∏≤‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏ã‡πâ‡∏≥
let lastPostId = null;
async function checkCollegeNews() {
    try {
        console.log("üì° ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πà‡∏≤‡∏ß‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢...");
        const response = await axios.get("https://www.sptc.ac.th/home/", {
            headers: { 'User-Agent': 'Mozilla/5.0' },
            timeout: 10000 // ‡πÄ‡∏û‡∏¥‡πà‡∏° timeout ‡∏Å‡∏±‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á
        });

        const $ = cheerio.load(response.data);
        const firstPost = $('article').first(); 
        const title = firstPost.find('h2, h3').first().text().trim() || "‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå";
        const link = firstPost.find('a').attr('href');
        let imageUrl = firstPost.find('img').attr('data-src') || firstPost.find('img').attr('src');

        if (!link) return;

        let savedStatus = await SystemStatus.findOne({ key: "last_news_id" });
        const lastSavedId = savedStatus ? savedStatus.value : null;

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Global ‡πÄ‡∏™‡∏°‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ AI ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≠‡∏ö
        global.latestNewsTitle = title;
        global.latestNewsLink = link;
        global.latestNewsDate = moment().tz("Asia/Bangkok").format("D MMMM YYYY");

        if (link !== lastSavedId) {
            console.log("üÜï ‡∏û‡∏ö‡∏Ç‡πà‡∏≤‡∏ß‡πÉ‡∏´‡∏°‡πà! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏Ç‡πà‡∏≤‡∏ß...");
            if (!savedStatus) {
                await SystemStatus.create({ key: "last_news_id", value: link });
            } else {
                savedStatus.value = link;
                await savedStatus.save();
            }

            // ‡∏™‡πà‡∏á Broadcast
            await client.broadcast({
                type: "flex",
                altText: `üì¢ ‡∏Ç‡πà‡∏≤‡∏ß‡πÉ‡∏´‡∏°‡πà: ${title}`,
                contents: {
                    type: "bubble",
                    hero: { 
                        type: "image", url: imageUrl || "https://www.sptc.ac.th/home/wp-content/uploads/2021/03/logo-sptc.png", 
                        size: "full", aspectRatio: "20:13", aspectMode: "cover" 
                    },
                    body: {
                        type: "box", layout: "vertical",
                        contents: [
                            { type: "text", text: "üì¢ ‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÉ‡∏´‡∏°‡πà", weight: "bold", color: "#e67e22", size: "sm" },
                            { type: "text", text: title, weight: "bold", size: "md", wrap: true, margin: "md" },
                            { type: "text", text: `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${global.latestNewsDate}`, size: "xs", color: "#aaaaaa", margin: "sm" }
                        ]
                    },
                    footer: {
                        type: "box", layout: "vertical",
                        contents: [{ type: "button", action: { type: "uri", label: "‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î", uri: link }, style: "primary", color: "#2c3e50" }]
                    }
                }
            });
        }
    } catch (err) {
        console.error("‚ùå News Sync Error:", err.message);
    }
}

//=========================================

// ========================================
// WEBHOOK
// ========================================
app.post("/webhook", line.middleware(config), async (req, res) => {
  try {
    await Promise.all(req.body.events.map(handleEvent));
    res.json({ status: "ok" });
  } catch (err) {
    console.error(err);
    res.status(500).end();
  }
});

// ========================================
// MAIN LOGIC - handleEvent
// ========================================
async function handleEvent(event) {
    if (event.type !== "message" || !["text", "image"].includes(event.message.type)) {
        return; 
    }

    const userId = event.source?.userId;
    if (!userId) return;

    let user = await User.findOne({ userId: userId });

    // ===== 1. CREATE USER / INITIAL CHECK =====
    if (!user) {
        user = new User({ userId: userId, step: "ask_realname", badCount: 0 });
        await user.save();
        return reply(event, "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏∏‡∏¢‡∏°‡∏≤‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏Å‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö üòä\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå **‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á** ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö");
    }

    // ===== 2. IMAGE LOGIC =====
    if (event.message.type === "image") {
        return await handleImageMessage(event, user); 
    }

    // ===== 3. TEXT LOGIC =====
    const text = event.message.text.trim();
    const lower = text.toLowerCase();
    const now = moment().tz("Asia/Bangkok").locale("th");

    // ===== 4. BLOCKED CHECK =====
    if (user.blockedUntil && moment().isBefore(user.blockedUntil)) {
        const diff = moment(user.blockedUntil).diff(moment(), "seconds");
        return reply(event, `‚õî ‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏≠‡∏µ‡∏Å ${diff} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`);
    }

    // ===== 5. GLOBAL BAD WORD & SPAM FILTER (ULTIMATE VERSION) =====
    const msgType = detectMessageType(text);

    if (msgType === "badword") {
        user.badCount = (user.badCount || 0) + 1;
        
        // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏£‡∏ö 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (return)
        if (user.badCount >= 3) {
            user.blockedUntil = moment().add(3, "minutes");
            user.badCount = 0; 
            await user.save();
            return reply(event, "‚õî ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô 3 ‡∏ô‡∏≤‡∏ó‡∏µ\n‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡πÑ‡∏°‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û‡∏ã‡πâ‡∏≥‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå‡∏Ñ‡∏£‡∏±‡∏ö");
        }

        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ï‡πâ‡∏°‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        await user.save();
        await increaseWarning(user); 
        return reply(event, `‚ö†Ô∏è [‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡∏≥‡∏´‡∏¢‡∏≤‡∏ö] ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏Ñ‡∏£‡∏±‡∏ö (‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${user.badCount}/3)`);
    }

    if (msgType === "spam") {
        return reply(event, "‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏™‡πÅ‡∏õ‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
    }

    // ===== 6. LENGTH & GARBAGE CHECK =====
    if (text.length > 50 || /^[^‡∏Å-‡πôa-zA-Z0-9\s]+$/.test(text))
        return reply(event, "‚ùå ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ö");

    // ===== 7. CHANGE COMMANDS (‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•) =====
    if (lower.includes("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô")) {
        user.step = "ask_nickname_only";
        await user.save();
        return reply(event, "‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö üòä\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢");
    }
    if (lower.includes("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠")) {
        user.step = "ask_realname_only";
        await user.save();
        return reply(event, "‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö üòä\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢");
    }
    if (lower.includes("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏≤‡∏¢‡∏∏")) {
        user.step = "ask_age_only";
        await user.save();
        return reply(event, "‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö üòä\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì");
    }

    // ===== 8. ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô =====
    if (lower === "‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô") {
        user.step = "report_title";
        await user.save();
        return reply(event, "üì¢ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ö\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå **‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤** ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏Ñ‡∏£‡∏±‡∏ö");
    }
    if (user.step === "report_title") {
        user.tempReport = { title: text };
        user.step = "report_detail";
        await user.save();
        return reply(event, "‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏Ç‡∏≠‡∏ó‡∏£‡∏≤‡∏ö **‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤** ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏±‡∏Å‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö");
    }
    if (user.step === "report_detail") {
        if (user.tempReport) user.tempReport.detail = text;
        user.step = "report_photo";
        await user.save();
        return reply(event, "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ **‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö** ‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö? (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ß‡πà‡∏≤ '‡πÑ‡∏°‡πà‡∏°‡∏µ' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)");
    }
    if (user.step === "report_photo") {
        if (lower !== "‡πÑ‡∏°‡πà‡∏°‡∏µ") {
            return reply(event, "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå '‡πÑ‡∏°‡πà‡∏°‡∏µ' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≤‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ");
        }
        const reportSummary = `‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\n` +
                              `üìå ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠: ${user.tempReport?.title || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"}\n` +
                              `üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${user.tempReport?.detail || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"}\n` +
                              `üë§ ‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á: ${user.realName} (‡πÅ‡∏ú‡∏ô‡∏Å ${user.department})`;
        user.step = "done";
        user.tempReport = undefined; 
        await user.save();
        return reply(event, reportSummary);
    }

    // ===== 9. REGISTER FLOW (CORE LOGIC) =====
    
    const isRegistered = user.realName && user.nickName && user.age && user.department;

    // STEP: ASK REALNAME
    if (user.step && user.step.startsWith("ask_realname")) {
        const isOnly = user.step.endsWith("_only");
        
        if (lower === "‡∏Ç‡πâ‡∏≤‡∏°" && !isOnly) {
            return reply(event, "‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡πâ‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");
        }

        if (containsBadWord(text)) return reply(event, "‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û‡∏Ñ‡∏£‡∏±‡∏ö");
        if (isForbidden(text)) return reply(event, `‚ùå "${text}" ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö`);
        if (!isStrictlyHumanName(text)) return reply(event, "‚ùå ‡∏î‡∏π‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ö (‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)");

        // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πà‡∏≤‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ Optional Chaining
if (user.realName && nameStats?.real?.[user.realName]) {
    nameStats.real[user.realName] = Math.max(0, nameStats.real[user.realName] - 1);
    if (nameStats.real[user.realName] === 0) delete nameStats.real[user.realName];
}

    user.realName = text;
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏≠‡∏á Object ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà
    if (!nameStats.real) nameStats.real = {}; 
    nameStats.real[text] = (nameStats.real[text] || 0) + 1;

        const isRegistered = user.nickName && user.age && user.department;
        
        if (isOnly || isRegistered) {
            user.step = "done";
            await user.save();
            saveStats();
            return reply(event, `‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏õ‡πá‡∏ô: **${text}**`);
        } else {
            user.step = "ask_nickname";
            await user.save();
            saveStats();
            return reply(event, `‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Ñ‡∏∏‡∏ì${text} üòä\n‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏Ç‡∏≠‡∏ó‡∏£‡∏≤‡∏ö **‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô** ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö`);
        }
    }

    // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] STEP: ASK DEPARTMENT
    if (user.step === "ask_department") {
        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö Case-insensitive
        const foundDept = DEPARTMENTS.find(d => 
            text.toLowerCase().includes(d.toLowerCase())
        );

        if (!foundDept) {
            return reply(event, `‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á SPTC\n\n‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏≤‡∏Ç‡∏≤: ‡∏ä‡πà‡∏≤‡∏á‡∏¢‡∏ô‡∏ï‡πå, ‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®, IT\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏±‡∏ö`);
        }
        
        user.department = foundDept;
        user.step = "done";
        
        try {
            await user.save();
            saveStats();
            return reply(event, `‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\nüë§ ${user.realName}\nüé≠ ${user.nickName}\n‚öôÔ∏è ‡πÅ‡∏ú‡∏ô‡∏Å ${user.department}\nüéÇ ‡∏≠‡∏≤‡∏¢‡∏∏ ${user.age} ‡∏õ‡∏µ`);
        } catch (err) {
            console.error("Save Error:", err);
            return reply(event, "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
        }
    }

    // STEP: ASK NICKNAME
    if (user.step && user.step.startsWith("ask_nickname")) {
        const isOnly = user.step.endsWith("_only");

        if (containsBadWord(text)) return reply(event, "‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û‡∏Ñ‡∏£‡∏±‡∏ö");
        if (isForbidden(text)) return reply(event, `‚ùå "${text}" ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö`);
        if (!isHumanName(text, 1, 15)) return reply(event, "‚ùå ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ö");
        if (text === user.realName) return reply(event, "‚ö†Ô∏è ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á‡∏Ñ‡∏£‡∏±‡∏ö");

        if (!isLikelyNickname(text)) {
            return reply(event, "‚ö†Ô∏è ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏°‡∏±‡∏Å‡∏à‡∏∞‡∏™‡∏±‡πâ‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö\n‡∏ñ‡πâ‡∏≤‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏£‡∏¥‡∏á ‡πÜ ‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ã‡πâ‡∏≥‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ üòä");
        }

        if (!isOnly && looksSwapped(user.realName, text)) {
            user.realName = ""; 
            user.step = "ask_realname"; 
            await user.save();
            return reply(event, "‚ö†Ô∏è ‡∏î‡∏π‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå **‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á** ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏±‡∏ö");
        }

        // ... ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô if (user.step && user.step.startsWith("ask_nickname")) ...

    // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà] ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πà‡∏≤
    if (user.nickName && nameStats?.nick?.[user.nickName]) {
     nameStats.nick[user.nickName] = Math.max(0, nameStats.nick[user.nickName] - 1);
        if (nameStats.nick[user.nickName] === 0) delete nameStats.nick[user.nickName];
}

    user.nickName = text;
    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Object ‡πÉ‡∏´‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°
        if (!nameStats.nick) nameStats.nick = {};
        nameStats.nick[text] = (nameStats.nick[text] || 0) + 1;

// ... ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å user.save() ‡πÅ‡∏•‡∏∞ saveStats() ...

        if (isOnly || isRegistered) {
            user.step = "done";
            await user.save();
            saveStats();
            return reply(event, `‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏õ‡πá‡∏ô: **${text}**`);
        } else {
            user.step = "ask_age";
            await user.save();
            saveStats();
            return reply(event, "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏Ç‡∏≠‡∏ó‡∏£‡∏≤‡∏ö **‡∏≠‡∏≤‡∏¢‡∏∏** ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏±‡∏ö üéÇ");
        }
    }

    // STEP: ASK AGE
    if (user.step && user.step.startsWith("ask_age")) {
        const ageInput = parseInt(text);
        const isOnly = user.step.endsWith("_only");
        
        if (isNaN(ageInput) || ageInput < 1 || ageInput > 60) {
            return reply(event, "‚ùå ‡∏≠‡∏≤‡∏¢‡∏∏‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 1-60 ‡∏õ‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö");
        }
        
        user.age = ageInput;
        
        if (isOnly || isRegistered) {
            user.step = "done";
            await user.save();
            return reply(event, `‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏õ‡πá‡∏ô: **${ageInput} ‡∏õ‡∏µ**`);
        } else {
            user.step = "ask_birthday";
            await user.save();
            return reply(event, '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö?\n‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 20/11/2548\n‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå "‡∏Ç‡πâ‡∏≤‡∏°"');
        }
    }

    // STEP: ASK BIRTHDAY
    if (user.step === "ask_birthday") {
        if (lower === "‡∏Ç‡πâ‡∏≤‡∏°") {
            user.birthday = null;
        } else {
            if (!moment(text, "DD/MM/YYYY", true).isValid()) {
                return reply(event, "‚ùå ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ö (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 20/11/2548)");
            }
            user.birthday = text;
        }
        
        // ‡∏ñ‡πâ‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏à‡∏ö‡πÄ‡∏•‡∏¢ ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏ñ‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡∏Å
        if (isRegistered) {
            user.step = "done";
            await user.save();
            return reply(event, "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö!");
        } else {
            user.step = "ask_department"; 
            await user.save();
            return reply(event, `‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏Ç‡∏≠‡∏ó‡∏£‡∏≤‡∏ö **‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤** ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏±‡∏ö\n‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏ä‡πà‡∏≤‡∏á‡∏¢‡∏ô‡∏ï‡πå, ‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®`);
        }
    }

    // STEP: ASK DEPARTMENT
    if (user.step === "ask_department") {
        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏î‡∏¢‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏∑‡πà‡∏ô‡∏õ‡∏ô‡∏°‡∏≤
        const foundDept = DEPARTMENTS.find(d => 
            text.toLowerCase().includes(d.toLowerCase())
        );

        if (!foundDept) {
            return reply(event, `‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á SPTC\n\n‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏≤‡∏Ç‡∏≤: ‡∏ä‡πà‡∏≤‡∏á‡∏¢‡∏ô‡∏ï‡πå, ‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®, IT, ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏±‡∏ö`);
        }
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ DEPARTMENTS
        user.department = foundDept;
        user.step = "done";
        
        try {
            await user.save();
            saveStats();
            
            const successMsg = `üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö!\n‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢\n\n` +
                               `üë§ ‡∏ä‡∏∑‡πà‡∏≠: ${user.realName}\n` +
                               `üé≠ ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô: ${user.nickName}\n` +
                               `‚öôÔ∏è ‡πÅ‡∏ú‡∏ô‡∏Å: ${user.department}\n` +
                               `üéÇ ‡∏≠‡∏≤‡∏¢‡∏∏: ${user.age} ‡∏õ‡∏µ\n\n` +
                               `‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡∏û‡∏µ‡πà‡∏ö‡∏≠‡∏ó ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ü§ñ`;
            
            return reply(event, successMsg);
        } catch (saveErr) {
            console.error("‚ùå Save User Error:", saveErr);
            return reply(event, "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏±‡∏ö");
        }
    }

    // ===== 10. MULTI INTENT (TIME/DATE/AGE/NEWS) =====
    const answers = [];
    const todayStr = now.format("D MMMM YYYY");
    const yesterdayStr = now.clone().subtract(1, 'days').format("D MMMM YYYY");

    // --- ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤/‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ---
    if (lower.includes("‡∏Å‡∏µ‡πà‡πÇ‡∏°‡∏á") || lower.includes("‡πÄ‡∏ß‡∏•‡∏≤")) answers.push(`‚è∞ ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ß‡∏•‡∏≤ ${now.format("HH:mm")} ‡∏ô.`);
    if (lower.includes("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà") || lower.includes("‡∏ß‡∏±‡∏ô‡∏≠‡∏∞‡πÑ‡∏£")) answers.push(`üìÖ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${todayStr}`);
    if (lower.includes("‡∏õ‡∏µ‡∏≠‡∏∞‡πÑ‡∏£")) answers.push(`üóì ‡∏õ‡∏µ ‡∏û.‡∏®. ${now.year() + 543}`);

    // --- ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡πà‡∏≤‡∏ß (‡πÅ‡∏¢‡∏Å ‡∏Ç‡πà‡∏≤‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î / ‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô) ---
    if (lower.includes("‡∏Ç‡πà‡∏≤‡∏ß")) {
        const newsList = await getLatestNews(2); // ‡∏î‡∏∂‡∏á‡∏°‡∏≤ 2 ‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
        
        if (newsList.length > 0) {
            let selectedNews = newsList[0];
            let statusText = "‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î! üî•";

            // ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤ "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤" ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 2
            if (lower.includes("‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô") || lower.includes("‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤") || lower.includes("‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß")) {
                if (newsList.length > 1) {
                    selectedNews = newsList[1];
                    statusText = "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô/‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ üì∞";
                } else {
                    return reply(event, "ü§ñ ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏û‡∏µ‡πà‡∏ö‡∏≠‡∏ó‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏Ñ‡πà‡∏Ç‡πà‡∏≤‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏≠‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö");
                }
            }

            return reply(event, `üì¢ **‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå** (${statusText})\n‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á: ${selectedNews.title}\nüîó ‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡πà‡∏≠: ${selectedNews.link}`);
        } else {
            return reply(event, "üì¢ ‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö");
        }
    }

    // --- ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏≤‡∏¢‡∏∏/‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î ---
    if (lower.includes("‡∏≠‡∏≤‡∏¢‡∏∏")) answers.push(user.age ? `üéÇ ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏ ${user.age} ‡∏õ‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö` : "‚ùó ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏¢‡∏∏");
    if (lower.includes("‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î")) {
        if (!user.birthday) {
            answers.push("‚ùó ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏£‡∏±‡∏ö (‡∏û‡∏¥‡∏°‡∏û‡πå '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏≤‡∏¢‡∏∏' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î)");
        } else {
            const parts = user.birthday.split("/");
            const d = parseInt(parts[0]), m = parseInt(parts[1]);
            let next = moment.tz(`${now.year()}-${m}-${d}`, "Asia/Bangkok");
            if (next.isBefore(now, "day")) next.add(1, "year");
            const diff = next.diff(now, "days");
            
            if (diff === 0) {
                answers.push(`üéÇ ‡∏™‡∏∏‡∏Ç‡∏™‡∏±‡∏ô‡∏ï‡πå‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì${user.nickName}! ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏û‡∏≠‡∏î‡∏µ‡πÄ‡∏•‡∏¢ ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏°‡∏≤‡∏Å ‡πÜ ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö üéâ`);
            } else {
                answers.push(`üéÇ ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Å‡∏¥‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${user.birthday} ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å ${diff} ‡∏ß‡∏±‡∏ô‡∏à‡∏∞‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏£‡∏±‡∏ö`);
            }
        }
    }

    if (answers.length > 0) return reply(event, answers.join("\n\n"));
    // ===== EXTRA: NAME INQUIRY =====
        if (lower.includes("‡∏ú‡∏°‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô") || lower.includes("‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏ú‡∏°")) {
        return reply(event, `üé≠ ‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏ß‡πà‡∏≤ **${user.nickName}** ‡∏Ñ‡∏£‡∏±‡∏ö`);
    }
    if (lower.includes("‡∏ú‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∞‡πÑ‡∏£") || lower.includes("‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á‡∏ú‡∏°")) {
        return reply(event, `üë§ ‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á‡∏ß‡πà‡∏≤ **${user.realName}** ‡∏Ñ‡∏£‡∏±‡∏ö`);
    }
    // ========================================

    // ===== 11. TOP NAME COMMAND =====
    if (lower === "/topname") {
        // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ obj || {} ‡πÅ‡∏•‡∏∞ Optional Chaining ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
        const top = (obj) => {
            if (!obj) return "-";
            const entries = Object.entries(obj);
            if (entries.length === 0) return "-";
            
            return entries
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([n, c]) => `${n} (${c})`)
                .join("\n") || "-";
        };

        const responseMsg = `üìä ‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°\n\n` +
                            `ü™™ ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á:\n${top(nameStats?.real)}\n\n` +
                            `üé≠ ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô:\n${top(nameStats?.nick)}`;

        return reply(event, responseMsg);
    }

    // ===== 12. OFFICIAL FACT & USER INFO =====
    if (lower.includes("‡∏ô‡∏≤‡∏¢‡∏Å")) return reply(event, `‡∏ô‡∏≤‡∏¢‡∏Å‡∏£‡∏±‡∏ê‡∏°‡∏ô‡∏ï‡∏£‡∏µ‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡∏Ñ‡∏∑‡∏≠ ${officialFacts.primeMinister} ‡∏Ñ‡∏£‡∏±‡∏ö`);
    if (lower.includes("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß") || lower.includes("‡∏Ç‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")) {
        const userInfo = `üìã **‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì**\n------------------\nüë§ ‡∏ä‡∏∑‡πà‡∏≠: ${user.realName}\nüé≠ ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô: ${user.nickName}\n‚öôÔ∏è ‡πÅ‡∏ú‡∏ô‡∏Å: ${user.department}\nüéÇ ‡∏≠‡∏≤‡∏¢‡∏∏: ${user.age} ‡∏õ‡∏µ\nüìÖ ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î: ${user.birthday || "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏"}\n------------------\nüí° ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏û‡∏¥‡∏°‡∏û‡πå: "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠" ‡∏´‡∏£‡∏∑‡∏≠ "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏≤‡∏¢‡∏∏"`;
        return reply(event, userInfo);
    }

    // ===== 13. NEW YEAR COUNTDOWN =====
    if (lower.includes("‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà") && (lower.includes("‡∏≠‡∏µ‡∏Å‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô") || lower.includes("‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å"))) {
        const now = moment().tz("Asia/Bangkok");
        const nextYear = now.year() + 1;
        const newYearDate = moment.tz(`${nextYear}-01-01 00:00:00`, "YYYY-MM-DD HH:mm:ss", "Asia/Bangkok");
        
        const daysLeft = newYearDate.diff(now, 'days');
        const hoursLeft = newYearDate.diff(now, 'hours') % 24;

        return reply(event, `üéÜ ‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏™‡∏π‡πà‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà ${nextYear}!\n\nüóì ‡∏≠‡∏µ‡∏Å‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì **${daysLeft} ‡∏ß‡∏±‡∏ô ${hoursLeft} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á** ‡∏à‡∏∞‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏£‡∏±‡∏ö!\n\n‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡∏â‡∏•‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÄ‡∏≠‡πà‡∏¢? ‚ú®`);
    }

    // ===== 14. AI FALLBACK (GPT-4o-mini) =====
    try {
        // 1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Context ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£
        const todayStr = now.format("dddd‡∏ó‡∏µ‡πà D MMMM YYYY");
        const newsContext = global.latestNewsTitle 
            ? `‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠: "${global.latestNewsTitle}"\n‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ${global.latestNewsDate}\n‡∏•‡∏¥‡∏á‡∏Å‡πå: ${global.latestNewsLink}` 
            : "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ";

        // 2. ‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏π‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á AI
        const systemInstruction = `
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡∏û‡∏µ‡πà‡∏ö‡∏≠‡∏ó SPTC" ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞‡∏Ç‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏¢‡∏≤‡∏°‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à (SPTC)
‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å: ‡∏™‡∏∏‡∏†‡∏≤‡∏û, ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô, ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢ "‡∏Ñ‡∏£‡∏±‡∏ö", ‡∏Å‡∏£‡∏∞‡∏ï‡∏∑‡∏≠‡∏£‡∏∑‡∏≠‡∏£‡πâ‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤

‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢: ${JSON.stringify(collegeData)}

‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å:
1. ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠${todayStr}
2. ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${newsContext}
3. ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ñ‡∏ô‡∏ñ‡∏≤‡∏°‡∏ñ‡∏∂‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ/‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏Ç‡πà‡∏≤‡∏ß ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏ö‡∏≠‡∏Å‡∏Ç‡πà‡∏≤‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÅ‡∏ó‡∏ô
4. ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å collegeData ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤, ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà, ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå
5. ‡∏´‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÑ‡∏ß‡πâ ‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡πÅ‡∏ó‡∏ô
`;

        const userContext = `‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö: ‡∏Ñ‡∏∏‡∏ì${user.realName || "‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"} (‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô: ${user.nickName || "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏"}), ‡πÅ‡∏ú‡∏ô‡∏Å: ${user.department || "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏"}, ‡∏≠‡∏≤‡∏¢‡∏∏: ${user.age || "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏"} ‡∏õ‡∏µ`;

        const response = await openai.chat.completions.create({
            model: "gpt-4o-mini",
            messages: [
                { role: "system", content: systemInstruction.trim() },
                { role: "system", content: userContext },
                { role: "user", content: text }
            ],
            max_tokens: 450,
            temperature: 0.7, // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏´‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤
        });

        const aiReply = response.choices[0].message.content;
        return reply(event, aiReply);

    } catch (err) {
        console.error("‚ùå AI Fallback Error:", err.message);
        if (err.message.includes("429")) {
            return reply(event, "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å ‡∏û‡∏µ‡πà‡∏ö‡∏≠‡∏ó‡∏ï‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö üôè");
        }
        return reply(event, "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏™‡∏°‡∏≠‡∏á‡∏Å‡∏•‡∏Ç‡∏≠‡∏á‡∏û‡∏µ‡πà‡∏ö‡∏≠‡∏ó‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡∏ö‡∏π‡∏ï‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏£‡∏±‡∏ö... ü§ñ");
    }
} // ‡∏õ‡∏¥‡∏î‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô handleEvent

// ========================================
// IMAGE PROCESSING FUNCTION
// ========================================
async function handleImageMessage(event, user) {
    try {
        if (!user || (user.step !== "done" && user.step !== "report_photo")) {
            return reply(event, "‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö");
        }

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å external ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà LINE storage)
        if (event.message.contentProvider.type !== "line") {
            return reply(event, "‚ùå ‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏û‡∏µ‡πà‡∏ö‡∏≠‡∏ó‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡πÑ‡∏î‡πâ");
        }

        // ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å LINE Server
        const stream = await client.getMessageContent(event.message.id);
        const chunks = [];
        for await (const chunk of stream) { chunks.push(chunk); }
        const buffer = Buffer.concat(chunks);
        const base64Image = buffer.toString("base64");

        // --- ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 1: ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ---
        if (user.step === "report_photo") {
            const successMsg = `‚úÖ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß!\n\nüìå ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠: ${user.tempReport?.title || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"}\nüìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${user.tempReport?.detail || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"}\nüë§ ‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á: ${user.realName}\n\n‡∏û‡∏µ‡πà‡∏ö‡∏≠‡∏ó‡∏™‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏±‡∏ö üôè`;
            
            // ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á
            user.step = "done";
            user.tempReport = undefined;
            
            // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ User ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ö‡∏≠‡∏ó‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
            await reply(event, successMsg);
            
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å DB ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
            return await user.save();
        }

        // --- ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 2: ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏°‡∏≤‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö AI (Vision) ---
        if (user.step === "done") {
            // ‡πÅ‡∏à‡πâ‡∏á User ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏£‡∏≤‡∏∞ AI Vision ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ô‡∏≤‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
            await client.replyMessage(event.replyToken, { type: "text", text: "ü§ñ ‡∏û‡∏µ‡πà‡∏ö‡∏≠‡∏ó‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡∏ô‡∏∞..." });

            const response = await openai.chat.completions.create({
                model: "gpt-4o-mini",
                messages: [{
                    role: "user",
                    content: [
                        { type: "text", text: `‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞ '‡∏û‡∏µ‡πà‡∏ö‡∏≠‡∏ó' ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢ SPTC ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠ ${user.nickName} ‡πÅ‡∏ú‡∏ô‡∏Å ${user.department}` },
                        { type: "image_url", image_url: { url: `data:image/jpeg;base64,${base64Image}` } },
                    ],
                }],
                max_tokens: 500,
            });

            // ‡πÉ‡∏ä‡πâ Push Message ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Reply Token ‡∏≠‡∏≤‡∏à‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏´‡∏≤‡∏Å AI ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏¥‡∏î‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
            return client.pushMessage(user.userId, { 
                type: "text", 
                text: "üîç ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û:\n\n" + response.choices[0].message.content 
            });
        }
    } catch (err) {
        console.error("‚ùå AI Vision Error:", err);
        // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á
        return client.pushMessage(user.userId, { type: "text", text: "‚ùå ‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏û‡∏µ‡πà‡∏ö‡∏≠‡∏ó‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ" });
    }
}

// ========================================
// INITIALIZATION & CRON JOBS
// ========================================

// ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡πà‡∏≤‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å DB ‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
async function initGlobalStats() {
    try {
        console.log("üì¶ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (Initialization)...");
        const savedStatus = await SystemStatus.findOne({ key: "last_news_id" });
        
        // ‡∏£‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πà‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ Global Variable
        await checkCollegeNews();
        
        if (savedStatus) {
            console.log(`‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡πà‡∏≤‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${savedStatus.value}`);
        }
    } catch (err) {
        console.error("‚ùå Init Error:", err);
    }
}

// ‡∏£‡∏±‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö
initGlobalStats();

// ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πà‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏ó‡∏∏‡∏Å 30 ‡∏ô‡∏≤‡∏ó‡∏µ
cron.schedule("*/30 * * * *", () => {
    checkCollegeNews();
});

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏Ç‡πà‡∏≤‡∏ß)
async function getLatestNews(limit = 1) {
    try {
        const response = await axios.get("https://www.sptc.ac.th/home/");
        const $ = cheerio.load(response.data);
        const news = [];

        $(".elementor-post__title a").each((i, el) => {
            if (i < limit) {
                news.push({
                    title: $(el).text().trim(),
                    link: $(el).attr("href")
                });
            }
        });
        return news;
    } catch (err) {
        console.error("‚ùå News Fetch Error:", err);
        return [];
    }
}

// ========================================
// SERVER START
// ========================================
app.get("/", (_, res) => res.send("ü§ñ SPTC Bot is Online and Ready!"));
app.listen(8080, () => console.log("üöÄ Server is running on port 8080"));
